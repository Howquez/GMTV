---
title: "Growth & Inequality in Dynamic Public Goods Games"
description: |
  Reproducing Gächter et al.'s main findings.
author: "Hauke Roggenkamp"
date: "`r Sys.Date()`"
bibliography: biblio.bib
output:
  pdf_document: default
  distill::distill_article:
    toc: true
    toc_depth: 2
    toc_float: false
    code_folding: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(haven)
library(data.table)
library(magrittr)
library(DescTools) # gini coefficient
library(sjPlot)
library(stargazer)
library(plm)
library(lmtest)
library(ggplot2)
library(wesanderson)
library(patchwork)

```

```{r functions}

# regressions 
gdp_ols <- function(DT, var = "gdp", output = "plm"){
  p.df <- DT %>% pdata.frame(index = c("gr_id"))
  plm <- plm(get(var) ~ punish, data = p.df, model = "pooling")
  # plm
  G <- length(unique(p.df$gr_id))
  N <- length(p.df$gr_id)
  dfa <- (G/(G - 1)) * (N - 1) / plm$df.residual
  group_c_vcov <- dfa * vcovHC(plm, type = "HC0", cluster = "group", adjust = T)
  # coeftest(plm, vcov = group_c_vcov)
  se <- sqrt(diag(group_c_vcov))
  # se
  
  if (output == "plm") {
    plm
  } else {
    se
  }
  
}

layout <- theme(panel.background = element_rect(fill = "white"),
                panel.grid = element_blank(),
                panel.grid.major.y = element_line(colour="gray", size=0.25),
                legend.key = element_rect(fill = "white"),
                axis.line.x.bottom = element_line(size = 0.25),
                axis.line.y.left = element_line(size = 0.25),
                # plot.margin = unit(c(1,1,1,1), "cm"),
                legend.title = element_blank()
                )

```


# Introduction 

In an attempt to incorporate uncertainty to @GACHTER2017's dynamic public goods game (DPGG), I plan to run a series of remote online experiments using oTree [@oTree]. The first experiment will replicate Gächter et al.'s NOPUNISH 10-period version as close as possible (given the remote circumstances). The current demo version of the experiment can be found [here](https://cliccs.herokuapp.com/). Click [here](https://github.com/Howquez/coopUncertainty) to visit the corresponding Github repository.

This document explores the data provided by @GACHTER2017 and finds that some of the variables are a little off. In addition, it fails to replicate the orginal article's figures. The following chapter will describe the available data. Subsequently, [data excerpts](#Tables) will demonstrate that the original _Gini coefficient_ varies within groups (in selected periods) and the _share of current endowment contributed_ is calculated using the last round's endowment. [Afterwards](#Downloads), the data is processed and made available for downloads.The [Visualizations](#Visualizations) chapter will then present the original figures as well as figures reproduced using the original and re-calculated variables to demonstrate differences.


# Original Data

## Description

The data can be found in the supplementary materials they provide in the [online appendix](https://www.sciencedirect.com/science/article/pii/S0047272717300361#s0115) and contains, among others, the following variables:

- ```exp_num``` is a session identifier
- ```per``` denotes the period
- ```gr_id``` is a group identifier (carrying treatment information)
- ```subj_id``` is a subject identifier
- ```tokens``` reports a subject's endowment in a period
- ```other[1-3]``` report the other group members' endowments in a period
- ```gdp ``` equals the sum of endowments of a group in a period
- ```putin``` reports a subject's contribution in a period
- ```pu[1-3]``` report the other group members' contributions in a period
- ```sum``` equals the sum of contributions of a group in a period
- ```gini``` reports a group's Gini coefficient in a period
- ```mean``` reports the fraction of sum/lagged(gdp)
- ```totallost``` ?

I add three new measures, namely: ```gini2```, ```mean2``` and ```gpd2```. ```gini2``` differs from the original as it is constant within groups. ```mean2``` is equivalent to the original ```mean``` but relies on the current ```gdp``` instead of the lagged measure. In addition to the ```gpd``` (stating the endowment at the _beginning_ of a period), I calculate ```gpd2``` for the noPunish treatments and thereby report the income at the _end_ of a period. Finally, I create a ```treatment``` string-variable .


```{r createVars, include = FALSE}

GMTV <- read_dta(file="../../data/gaechteretal/GMTV-data.dta") %>% data.table()

# treatments

  GMTV[punish == 0 & longgame == 0, # exp_num == 5 | exp_num == 8 | exp_num == 9,
       treatment := "noPunish10"]
  
  GMTV[punish == 0 & longgame == 1, # exp_num == 1 | exp_num == 3,
       treatment := "noPunish15"]
  
  GMTV[punish == 1 & longgame == 0, # exp_num == 4 | exp_num == 6 | exp_num == 10,
       treatment := "Punish10"]
  
  GMTV[punish == 1 & longgame == 1, # exp_num == 2 | exp_num == 7,
       treatment := "Punish15"]

# gdp, mean & gini
  GMTV[treatment == "noPunish10" | treatment == "noPunish15",
       gdp2 := (gdp + ceiling(sum/4*1.5)*4-sum)]
  
  GMTV[,
       mean2 := sum/gdp]
  
  GMTV[,
       gini2 := Gini(c(tokens, other1, other2, other3)),
       by = .(treatment, gr_id, per)]
  
  GMTV[is.nan(gini2),
       gini2 := 0]
  
# rearrange & subset
  
GMTV <- GMTV[exp_num <= 10]
GMTV <- GMTV[order(treatment, gr_id, per),
             .(treatment, treat, punish = as.logical(punish), longgame = as.logical(longgame),        # treatment vars 
               exp_num, gr_id, per, subj_id,              # IDs
               tokens, other1, other2, other3, gdp, gdp2, # endowments
               putin, pu1, pu2, pu3, sum, mean, mean2,    # contributions
               gini, gini2,                               # ginis
               totallost,                                 # punishment var
               highgdp
              )]

# remove duplicate rows while subsetting only group level variables
GMTVgroups <- GMTV[exp_num <= 10,
                   .(treatment,
                     treat,
                     punish = as.logical(punish),
                     longgame = as.logical(longgame),
                     exp_num,
                     gr_id,
                     per,
                     sum,
                     gdp,
                     mean,
                     mean2,
                     # gini,
                     gini2,
                     highgdp = as.logical(highgdp))] %>% unique()

# GMTVgroups <- GMTV[exp_num <= 10,
#                    lapply(.SD, mean, na.rm = TRUE),
#                    by = c("gr_id"),
#                    .SDcols = c()]

# subsets for regression tables
GMTV_short_all  <- GMTV[longgame == 0 & treat < 3 & per == 10]
GMTV_short_poor <- GMTV[longgame == 0 & treat < 3 & per == 10 & highgdp == 0]
GMTV_short_rich <- GMTV[longgame == 0 & treat < 3 & per == 10 & highgdp == 1]
GMTV_long_all   <- GMTV[longgame == 1 & treat > 100 & per == 15]
GMTV_long_poor  <- GMTV[longgame == 1 & treat > 100 & per == 15 & highgdp == 0]
GMTV_long_rich  <- GMTV[longgame == 1 & treat > 100 & per == 15 & highgdp == 1]
```



# Tables

## Table 2: OLS Regression Wealth

```{r stargazerGDP, results = "asis"}

if(knitr::is_html_output()){
  type <- "html"
} else {
  type = "latex"
}

stargazer(gdp_ols(GMTV_short_all),
          gdp_ols(GMTV_short_poor),
          gdp_ols(GMTV_short_rich),
          gdp_ols(GMTV_long_all),
          gdp_ols(GMTV_long_poor),
          gdp_ols(GMTV_long_rich),
          
          se = list(gdp_ols(GMTV_short_all,  output = "se"),
                    gdp_ols(GMTV_short_poor, output = "se"),
                    gdp_ols(GMTV_short_rich, output = "se"),
                    gdp_ols(GMTV_long_all,   output = "se"),
                    gdp_ols(GMTV_long_poor,  output = "se"),
                    gdp_ols(GMTV_long_rich,  output = "se")),
          
          add.lines = list(c("Long Game?", "No", "No", "No", "Yes", "Yes", "Yes")),
          
          column.labels = rep(c("All", "Below median", "Above median"), 2),
          model.numbers = FALSE,
          dep.var.labels = "Wealth (Table 2)",
          notes = "Robust standard errors in parentheses",
          header=FALSE,

          type = type, digits = 2, omit.stat = c("adj.rsq", "f")
          )
```


## Table 3: OLS Regression Gini coefficient

```{r stargazerGini, results = "asis"}

if(knitr::is_html_output()){
  type <- "html"
} else {
  type = "latex"
}

stargazer(gdp_ols(GMTV_short_all,  var = "gini"),
          gdp_ols(GMTV_short_poor, var = "gini"),
          gdp_ols(GMTV_short_rich, var = "gini"),
          gdp_ols(GMTV_long_all,   var = "gini"),
          gdp_ols(GMTV_long_poor,  var = "gini"),
          gdp_ols(GMTV_long_rich,  var = "gini"),
          
          se = list(gdp_ols(GMTV_short_all,  var = "gini", output = "se"),
                    gdp_ols(GMTV_short_poor, var = "gini", output = "se"),
                    gdp_ols(GMTV_short_rich, var = "gini", output = "se"),
                    gdp_ols(GMTV_long_all,   var = "gini", output = "se"),
                    gdp_ols(GMTV_long_poor,  var = "gini", output = "se"),
                    gdp_ols(GMTV_long_rich,  var = "gini", output = "se")),
          
          add.lines = list(c("Long Game?", "No", "No", "No", "Yes", "Yes", "Yes")),
          
          column.labels = rep(c("All", "Below median", "Above median"), 2),
          model.numbers = FALSE,
          dep.var.labels = "Original Gini coefficient (Table 3)",
          notes = "Robust standard errors in parentheses",
          header=FALSE,

          type = type, digits = 2, omit.stat = c("adj.rsq", "f")
          )
```


Table 3: OLS Regression re-calculated Gini

```{r stargazerGini2, results = "asis"}

if(knitr::is_html_output()){
  type <- "html"
} else {
  type = "latex"
}

stargazer(gdp_ols(GMTV_short_all,  var = "gini2"),
          gdp_ols(GMTV_short_poor, var = "gini2"),
          gdp_ols(GMTV_short_rich, var = "gini2"),
          gdp_ols(GMTV_long_all,   var = "gini2"),
          gdp_ols(GMTV_long_poor,  var = "gini2"),
          gdp_ols(GMTV_long_rich,  var = "gini2"),
          
          se = list(gdp_ols(GMTV_short_all,  var = "gini2", output = "se"),
                    gdp_ols(GMTV_short_poor, var = "gini2", output = "se"),
                    gdp_ols(GMTV_short_rich, var = "gini2", output = "se"),
                    gdp_ols(GMTV_long_all,   var = "gini2", output = "se"),
                    gdp_ols(GMTV_long_poor,  var = "gini2", output = "se"),
                    gdp_ols(GMTV_long_rich,  var = "gini2", output = "se")),
          
          add.lines = list(c("Long Game?", "No", "No", "No", "Yes", "Yes", "Yes")),
          
          column.labels = rep(c("All", "Below median", "Above median"), 2),
          model.numbers = FALSE,
          dep.var.labels = "Re-calculated Gini coefficient",
          notes = "Robust standard errors in parentheses",
          header=FALSE,

          type = type, digits = 2, omit.stat = c("adj.rsq", "f")
          )
```

# Figures

```{r plotContributions}

SUM <- GMTVgroups[, 
                    lapply(.SD, mean, na.rm = TRUE),
                    by = c("per", "treatment", "punish", "longgame"),
                    .SDcols = "sum"]

SUM[,
    sum := round(sum/4)]

ggplot(data = SUM, aes(x = per, y = sum, fill = treatment, color = treatment, lty = punish)) +
          layout +
          theme(legend.position="bottom") +
          geom_vline(xintercept = 10, alpha = 0.66) +
          geom_line(show.legend=FALSE) +
          geom_point() +
          scale_x_continuous(name="",  breaks = 1:15) +
          scale_y_continuous(breaks = seq(0, 150, by = 50), limits = c(0, 170), expand = c(0, 0)) +
          labs(y = "Average Amount of Tokens contributed") +
          scale_color_manual(values = wes_palette("Zissou1"))
```

```{r plotMeans}

means <- GMTVgroups[,
                    lapply(.SD, mean, na.rm = TRUE),
                    by = c("per", "treatment", "punish", "longgame"),
                    .SDcols = c("mean", "mean2")]


mean <- ggplot(data = means, aes(x = per, y = mean, fill = treatment, color = treatment, lty = punish)) +
          layout +
          theme(legend.position="none") +
          geom_vline(xintercept = 10, alpha = 0.66, size = 0.25) +
          geom_line(show.legend=FALSE) +
          geom_point() +
          scale_x_continuous(name="",  breaks = 1:15) +
          scale_y_continuous(breaks = seq(0, 1.2, by = 0.2), limits = c(0, 1.25), expand = c(0, 0)) +
          labs(y = "Share of past Endowment contributed") +
          scale_color_manual(values = wes_palette("Zissou1"))

mean2 <- ggplot(data = means, aes(x = per, y = mean2, fill = treatment, color = treatment, lty = punish)) +
          layout +
          theme(legend.position="none") +
          geom_vline(xintercept = 10, alpha = 0.66, size = 0.25) +
          geom_line(show.legend=FALSE) +
          geom_point() +
          scale_x_continuous(name="", breaks = 1:15) +
          scale_y_continuous(breaks = seq(0, 1.2, by = 0.2), limits = c(0, 1.25), expand = c(0, 0)) +
          labs(y = "Share of current Endowment contributed") +
          scale_color_manual(values = wes_palette("Zissou1"))

patchwork <- mean + mean2 & theme(legend.position = "bottom")
patchwork <- patchwork + plot_layout(guides = "collect")
patchwork

```

```{r summary1, results = "asis", warning = FALSE}

if(knitr::is_html_output()){
  type <- "html"
} else {
  type = "latex"
}

nopunish10 <- GMTVgroups[punish == FALSE & longgame == FALSE & exp_num <= 10 & per == 10, gdp]
punish10   <- GMTVgroups[punish == TRUE & longgame == FALSE & exp_num <= 10 & per == 10, gdp]
nopunish15 <- GMTVgroups[punish == FALSE & longgame == TRUE & exp_num <= 10 & per == 15, gdp]
punish15   <- GMTVgroups[punish == TRUE & longgame == TRUE & exp_num <= 10 & per == 15, gdp]

rows <- sapply(X = list(nopunish10, punish10, nopunish15, punish15), FUN = NROW) %>% max()
temp <- data.frame(nopunish10 = c(nopunish10, rep(NA, rows - NROW(nopunish10))),
                   punish10 = c(punish10, rep(NA, rows - NROW(punish10))),
                   nopunish15 = c(nopunish15, rep(NA, rows - NROW(nopunish15))),
                   punish15 = c(punish15, rep(NA, rows - NROW(punish15))))

stargazer(temp,
          summary.stat = c("mean", "median","sd", "max", "min", "n"),
          type = type, 
          flip = TRUE, 
          header=FALSE)

rs1 <- wilcox.test(nopunish10, punish10)$p.value %>% round(digits = 4)
rs2 <- wilcox.test(nopunish15, punish15)$p.value %>% round(digits = 4)

```

The rank sum tests yield p-Values of `r rs1` and `r rs2` for the mean ```gdp```s during the last period of the short and long games, respectively. This indicates that there is no significant difference between punish and nopunish treatments (at the 5%-level).


```{r olsWealth, eval = FALSE, include = FALSE}
m2.1  <- lm(gdp ~ punish, data = GMTV[longgame == 0 & treat < 3 & per == 10])
m2.2  <- lm(gdp ~ punish, data = GMTV[longgame == 0 & treat < 3 & per == 10 & highgdp == 0])
m2.3  <- lm(gdp ~ punish, data = GMTV[longgame == 0 & treat < 3 & per == 10 & highgdp == 1])


m2.4  <- lm(gdp ~ punish, data = GMTV[longgame == 1 & treat > 100 & per == 15])
m2.5  <- lm(gdp ~ punish, data = GMTV[longgame == 1 & treat > 100 & per == 15 & highgdp == 0])
m2.6  <- lm(gdp ~ punish, data = GMTV[longgame == 1 & treat > 100 & per == 15 & highgdp == 1])


tab_model(m2.1, m2.2, m2.3, m2.4, m2.5, m2.6,
          dv.labels = c("10All", "10Below", "10Above", "15All", "15Below", "15Above"),
          p.style = "stars",
          show.se = TRUE,
          show.ci = FALSE,
          show.p = FALSE, 
          transform = NULL)

# this function replicates the table but, unfortunately only row by row
tab_model(
  m2.2,
  vcov.fun = "CL", 
  vcov.type = "HC1",
  vcov.args = list(cluster = GMTV[longgame == 0 & treat < 3 & per == 10 & highgdp == 0, gr_id]),
  p.style = "stars",
  show.se = TRUE,
  show.ci = FALSE,
  show.p = FALSE,
  transform = NULL
)

# p.df <- GMTV[longgame == 0 & treat < 3 & per == 10 & highgdp == 0] %>% pdata.frame(index = c("gr_id"))
# plm <- plm(gdp ~ punish, data = p.df, model = "pooling")
# G <- length(unique(p.df$gr_id))
# N <- length(p.df$gr_id)
# dfa <- (G/(G - 1)) * (N - 1) / plm$df.residual
# group_c_vcov <- dfa * vcovHC(plm, type = "HC0", cluster = "group", adjust = T)
# # coeftest(plm, vcov = group_c_vcov)
# se <- sqrt(diag(group_c_vcov))
# 
# stargazer(plm, type = "html", digits = 2, se = list(se), omit.stat = c("rsq", "f"))

```

```{r olsGini2, eval = FALSE, include = FALSE}

m4.1  <- lm(gini2 ~ punish, data = GMTVgroups[longgame == 0 & treat < 3 & per == 10])
m4.2  <- lm(gini2 ~ punish, data = GMTVgroups[longgame == 0 & treat < 3 & per == 10 & highgdp == 0])
m4.3  <- lm(gini2 ~ punish, data = GMTVgroups[longgame == 0 & treat < 3 & per == 10 & highgdp == 1])

m4.4  <- lm(gini2 ~ punish, data = GMTVgroups[longgame == 1 & treat > 100 & per == 15])
m4.5  <- lm(gini2 ~ punish, data = GMTVgroups[longgame == 1 & treat > 100 & per == 15 & highgdp == 0])
m4.6  <- lm(gini2 ~ punish, data = GMTVgroups[longgame == 1 & treat > 100 & per == 15 & highgdp == 1])

tab_model(m4.1, m4.2, m4.3, m4.4, m4.5, m4.6,
          dv.labels = c("10All", "10Below", "10Above", "15All", "15Below", "15Above"),
          p.style = "stars",
          show.ci = FALSE,
          show.p = FALSE, 
          transform = NULL)
```

```{r eval = FALSE, include = FALSE}
# install.packages("plm")
# install.packages("lmtest")
# load packages
require(plm)
require(lmtest)  # for waldtest()
# get data and load as pdata.frame
url <- "http://www.kellogg.northwestern.edu/faculty/petersen/htm/papers/se/test_data.txt"
p.df <- read.table(url)
names(p.df) <- c("firmid", "year", "x", "y")
p.df <- pdata.frame(p.df, index = c("firmid", "year"), drop.index = F, row.names = T)
head(p.df)


# fit pooled OLS
m1 <- lm(y ~ x, data = p.df)
# fit same model with plm (needed for clustering)
pm1 <- plm(y ~ x, data = p.df, model = "pooling")


G <- length(unique(p.df$firmid))
N <- length(p.df$firmid)
dfa <- (G/(G - 1)) * (N - 1)/pm1$df.residual

firm_c_vcov <- dfa * vcovHC(pm1, type = "HC0", cluster = "group", adjust = T)
coeftest(pm1, vcov = firm_c_vcov)





tempDT <- p.df
names(tempDT)[names(tempDT) == "firmid"] <- "gr_id"
pm <- plm(y ~ x, data = tempDT, model = "pooling")
G <- length(unique(tempDT$gr_id))
N <- length(tempDT$gr_id)
dfa <- (G/(G - 1)) * (N - 1) / pm$df.residual
group_c_vcov <- dfa * vcovHC(pm1, type = "HC0", cluster = "group", adjust = T)
coeftest(pm1, vcov = group_c_vcov)


```

```{r, eval = FALSE, include = FALSE}
m2.1  <- lm(gdp ~ punish, data = GMTV[longgame == 0 & treat < 3 & per == 10])

plm2.1 <- plm(formula = gdp ~ punish,
              data = GMTV[longgame == 0 & treat < 3 & per == 10],
              model = "pooling",
              index = c("gr_id"))

summary(m2.1, cluster=c("gr_id"))
coeftest(plm2.1, vcov=vcovHC(plm2.1, type="sss", cluster="group"))

m3.4  <- lm(gini ~ punish, data = GMTV[longgame == 1 & treat > 100 & per == 15])
plm3.4 <- plm(formula = gini ~ punish,
              data = GMTV[longgame == 1 & treat > 100 & per == 15],
              model = "pooling",
              index = c("gr_id"))
summary(m3.4, cluster=c("gr_id"))
coeftest(plm3.4, vcov=vcovHC(plm3.4, type="sss", cluster="group"))



```

```{r, eval = FALSE, include = FALSE}
data(iris)
model <- lm(Petal.Length ~ Sepal.Length + Sepal.Width, data = iris)

# model parameters, where SE, CI and p-values are based on robust estimation
tab_model(model, vcov.fun = "HC", show.se = TRUE)

iris$cluster <- factor(rep(LETTERS[1:8], length.out = nrow(iris)))
# change estimation-type, defining additional arguments
tab_model(
  model, 
  vcov.fun = "CL", 
  vcov.type = "HC1",
  vcov.args = list(cluster = iris$cluster),
  show.se = TRUE
)

```

```{r eval = FALSE, include = FALSE}
library(data.table)
library(sjPlot)
data(iris)
DT <- data.table(iris)
DT[, cluster := factor(rep(LETTERS[1:8], length.out = nrow(iris)))]

m0 <- lm(Petal.Length ~ Sepal.Length + Sepal.Width, data = DT)
m1 <- lm(Petal.Length ~ Sepal.Length + Sepal.Width, data = DT[Petal.Width >= 1])
m2 <- lm(Petal.Length ~ Sepal.Length + Sepal.Width, data = DT[Petal.Width < 1])

tab_model(
  m0,
  vcov.fun = "CL", 
  vcov.type = "HC1",
  vcov.args = list(cluster = DT$cluster),
  show.se = TRUE
)

tab_model(
  m1,
  vcov.fun = "CL", 
  vcov.type = "HC1",
  vcov.args = list(cluster = DT[Petal.Width >= 1, cluster]),
  show.se = TRUE
)


```

# References