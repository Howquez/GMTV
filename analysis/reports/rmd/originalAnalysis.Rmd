---
title: "3. Analysis Plan"
description: |
  Analyze and compare data
author:
  - name: Hauke Roggenkamp 
    url: https://github.com/Howquez
    affiliation: CLICCS
    affiliation_url: https://www.cliccs.uni-hamburg.de/
date: "`r Sys.Date()`"
bibliography: ../biblio.bib
output:
  distill::distill_article:
    toc: true
    toc_depth: 2
    toc_float: false
    code_folding: true
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE)

library(data.table)
library(magrittr)
library(kableExtra)
library(downloadthis)
library(ggplot2)
library(patchwork)
library(stargazer)
```


# Background 

In an attempt to incorporate uncertainty to @GACHTER2017's dynamic public goods game (DPGG), I plan to run a series of remote online experiments using oTree [@oTree]. The first experiment will replicate GÃ¤chter et al.'s NOPUNISH 10-period version as close as possible (given the remote circumstances). The current demo version of the experiment can be found [here](https://cliccs.herokuapp.com/). Click [here](https://github.com/Howquez/coopUncertainty) to visit the corresponding Github repository.

[This report](https://github.com/Howquez/coopUncertainty/blob/July21Replication/analysis/reports/rmd/03_dataAnalyses.Rmd) is the third in a series of reports covering this project. It reads the data prepared in the previous reports and analyzes them.

```{r readData}
base::load(file="../../../data/processed/rda/GMTV2017.rda")              # read GMTV
base::load(file="../../../data/processed/rda/GMTV2017_R1.rda")           # read GMTVFirstRound
base::load(file="../../../data/processed/rda/GMTV2017_COVS.rda")         # read GMTVCovariates
base::load(file="../../../data/processed/rda/replication2021.rda")       # read replication
base::load(file="../../../data/processed/rda/replication2021_R1.rda")    # read replicationFirstRound
base::load(file="../../../data/processed/rda/replication2021_COVS.rda")  # read replicationCovariates
```

```{r cbind}
main <- rbindlist(list(replication, GMTV), 
                  use.names = TRUE)

R1   <- rbindlist(list(replicationFirstRound, GMTVFirstRound), 
                  use.names = TRUE)

covs <- rbindlist(list(replicationCovariates, GMTVCovariates), 
                  use.names = TRUE,
                  fill = TRUE)

rm(list = c("replication", "GMTV", "replicationFirstRound", "GMTVFirstRound", "GMTVCovariates", "replicationCovariates"))
```


# Results

```{r layout}
layout <- theme(panel.background = element_rect(fill = "white"),
                panel.grid = element_blank(),
                panel.grid.major.y = element_line(colour="gray", size=0.25),
                legend.key = element_rect(fill = "white"),
                axis.line.x.bottom = element_line(size = 0.25),
                axis.line.y.left = element_line(size = 0.25),
                axis.title.y = element_text(size = rel(0.75)),
                plot.margin = unit(c(0.25,0.25,0.25,0.25), "cm"),
                legend.title = element_blank()
                )

colors <- c("#F3B05C", "#1E4A75", "#65B5C0", "#AD5E21")
```


## First Round

```{r firstRound, eval = FALSE}
ggplot(R1, aes(y=ownContribution, x=othersContribution/3)) +
  layout +
  geom_abline(intercept = 0, slope = 1, linetype="dashed", alpha = 0.66) +
  geom_point(color = colors) +
  scale_y_continuous(expand = c(0, 0), limits = c(-1, 25)) +
  scale_x_continuous(expand = c(0, 0), limits = c(-1, 25))
  
```

## Provision of the public good and wealth creation

```{r plotContributions}

SUM <- main[,
            lapply(.SD, mean, na.rm = TRUE),
            by = c("round", "treatment"),
            .SDcols = "contribution"]

SUM[,
    sum := round(contribution/4)]

upperLimit <- SUM$contribution %>% max() %>% round() + 10

p1 <- ggplot(data = SUM, 
             aes(x = round, y = contribution, fill = treatment, color = treatment, lty = treatment)) +
  layout +
  theme(legend.position="bottom") +
  geom_line(show.legend=FALSE) +
  geom_point() +
  scale_x_continuous(name="",  breaks = 1:15) +
  scale_y_continuous(limits = c(0, upperLimit), expand = c(0, 0)) +
  labs(y = "Average Amount of Tokens contributed") +
  scale_color_manual(values = colors) + 
  theme(plot.margin = margin(0.25,1,0.25,0.25, "cm"))

rm(list = c("SUM"))
```


```{r plotShareOfContributions, fig.cap = "The average amount of tokens contributed over time in treatments."}

SHARE <- main[,
            lapply(.SD, mean, na.rm = TRUE),
            by = c("round", "treatment"),
            .SDcols = "share"]

upperLimit <- 1

p2 <- ggplot(data = SHARE, 
             aes(x = round, y = share, fill = treatment, color = treatment, lty = treatment)) +
  layout +
  theme(legend.position="bottom") +
  geom_line(show.legend=FALSE) +
  geom_point() +
  scale_x_continuous(name="",  breaks = 1:15) +
  scale_y_continuous(limits = c(0, upperLimit), expand = c(0, 0)) +
  labs(y = "Share of Current Endowment contributed") +
  scale_color_manual(values = colors)

p1 + p2 + plot_layout(guides = "collect") & theme(legend.position = "bottom")

rm(list = c("SHARE", "p1", "p2"))
```


```{r summary1, results = "asis", warning = FALSE, fig.cap = "test"}

if(knitr::is_html_output()){
  type <- "html"
} else {
  type = "latex"
}

replication <- main[treatment == "replication" & round == 10, stock]
GMTV    <- main[treatment == "noPunish10" & round == 10, stock]


rows <- sapply(X = list(replication, GMTV), FUN = NROW) %>% max()
temp <- data.frame(replication = c(replication, rep(NA, rows - NROW(replication))),
                   GMTV = c(GMTV, rep(NA, rows - NROW(GMTV))))

stargazer(temp,
          summary.stat = c("mean", "median","sd", "max", "min", "n"),
          type = type, 
          flip = TRUE, 
          header=FALSE)

rs1 <- wilcox.test(replication, 
                   GMTV,
                   exact = FALSE)$p.value %>% 
  round(digits = 4) %>% 
  formatC(format = "f", 
          digits = 4)

```

The rank sum test yields a p-Value of `r rs1` for the mean ```stock``` a.k.a _Wealth_ during the last period of the game.


```{r tableStock, results = "asis", warning = FALSE}

# create subsets
main_all  <- main[round == 10]
main_poor <- main[round == 10 & rich == FALSE]
main_rich <- main[round == 10 & rich == TRUE]

# create table
if(knitr::is_html_output()){
  type <- "html"
} else {
  type = "latex"
}

m1 <- lm(formula = stock ~ treatment, data = main_all)
m2 <- lm(formula = stock ~ treatment, data = main_poor)
m3 <- lm(formula = stock ~ treatment, data = main_rich)

stargazer(m1, m2, m3,

          column.labels = c("All", "Below median", "Above median"),
          model.numbers = FALSE,
          dep.var.labels = "Wealth",
          header=FALSE,
          covariate.labels = c("Replication"),

          type = type, digits = 2, omit.stat = c("adj.rsq", "f"), df = FALSE
          )
```

```{r plotStock, fig.cap = "Average wealth over time across treatments."}
STOCK <- main[,
              lapply(.SD, mean, na.rm = TRUE),
              by = c("round", "treatment"),
              .SDcols = "stock"]

STOCKr <- main[rich == TRUE,
               lapply(.SD, mean, na.rm = TRUE),
               by = c("round", "treatment"),
               .SDcols = "stock"]

STOCKp <- main[rich == FALSE,
               lapply(.SD, mean, na.rm = TRUE),
               by = c("round", "treatment"),
               .SDcols = "stock"]

upperLimit <- STOCKr$stock %>% max() %>% round() + 20

p1 <- ggplot(data = STOCK, 
       aes(x = round, y = stock, fill = treatment, color = treatment, lty = treatment)) +
          layout +
          theme(legend.position="bottom") +
          # geom_vline(xintercept = 10, alpha = 0.66) +
          geom_line(show.legend=FALSE) +
          geom_point() +
          scale_x_continuous(name="",  breaks = 1:10) +
          scale_y_continuous(limits = c(0, upperLimit), expand = c(0, 0)) +
          labs(y = "Wealth") +
          scale_color_manual(values = colors) + 
          theme(plot.margin = margin(0.25,1,0.25,0.25, "cm"))

p2 <- ggplot(data = STOCKr, 
       aes(x = round, y = stock, fill = treatment, color = treatment, lty = treatment)) +
          layout +
          theme(legend.position="bottom") +
          # geom_vline(xintercept = 10, alpha = 0.66) +
          geom_line(show.legend=FALSE) +
          geom_point() +
          scale_x_continuous(name="",  breaks = 1:10) +
          scale_y_continuous(limits = c(0, upperLimit), expand = c(0, 0)) +
          labs(y = "Wealth (Rich)") +
          scale_color_manual(values = colors)

p3 <- ggplot(data = STOCKp, 
       aes(x = round, y = stock, fill = treatment, color = treatment, lty = treatment)) +
          layout +
          theme(legend.position="bottom") +
          # geom_vline(xintercept = 10, alpha = 0.66) +
          geom_line(show.legend=FALSE) +
          geom_point() +
          scale_x_continuous(name="",  breaks = 1:10) +
          scale_y_continuous(limits = c(0, upperLimit), expand = c(0, 0)) +
          labs(y = "Wealth (Poor)") +
          scale_color_manual(values = colors)

(p1 | (p2 / p3)) + plot_layout(guides = "collect") & theme(legend.position = "bottom")

rm(list = c("STOCK", "STOCKr", "STOCKp", "p1", "p2", "p3"))
```


## Inequality

```{r plotInequality, fig.cap = "Average Gini coefficient over time across treatments."}
GINI <- main[,
             lapply(.SD, mean, na.rm = TRUE),
             by = c("round", "treatment"),
             .SDcols = "gini"]

GINIr <- main[rich == TRUE,
              lapply(.SD, mean, na.rm = TRUE),
              by = c("round", "treatment"),
              .SDcols = "gini"]

GINIp <- main[rich == FALSE,
              lapply(.SD, mean, na.rm = TRUE),
              by = c("round", "treatment"),
              .SDcols = "gini"]

upperLimit <- GINI$gini %>% max() %>% round(digits = 1) + 0.10

p1 <- ggplot(data = GINI, 
       aes(x = round, y = gini, fill = treatment, color = treatment, lty = treatment)) +
          layout +
          theme(legend.position="bottom") +
          # geom_vline(xintercept = 10, alpha = 0.66) +
          geom_line(show.legend=FALSE) +
          geom_point() +
          scale_x_continuous(name="",  breaks = 1:10) +
          scale_y_continuous(limits = c(0, upperLimit), expand = c(0, 0)) +
          labs(y = "Gini Coefficient") +
          scale_color_manual(values = colors) + 
          theme(plot.margin = margin(0.25,1,0.25,0.25, "cm"))

p2 <- ggplot(data = GINIr, 
       aes(x = round, y = gini, fill = treatment, color = treatment, lty = treatment)) +
          layout +
          theme(legend.position="bottom") +
          # geom_vline(xintercept = 10, alpha = 0.66) +
          geom_line(show.legend=FALSE) +
          geom_point() +
          scale_x_continuous(name="",  breaks = 1:10) +
          scale_y_continuous(limits = c(0, upperLimit), expand = c(0, 0)) +
          labs(y = "Gini (Rich)") +
          scale_color_manual(values = colors)

p3 <- ggplot(data = GINIp, 
       aes(x = round, y = gini, fill = treatment, color = treatment, lty = treatment)) +
          layout +
          theme(legend.position="bottom") +
          # geom_vline(xintercept = 10, alpha = 0.66) +
          geom_line(show.legend=FALSE) +
          geom_point() +
          scale_x_continuous(name="",  breaks = 1:10) +
          scale_y_continuous(limits = c(0, upperLimit), expand = c(0, 0)) +
          labs(y = "Gini (Poor)") +
          scale_color_manual(values = colors)

(p1 | (p2 / p3)) + plot_layout(guides = "collect") & theme(legend.position = "bottom")

rm(list = c("GINI", "GINIp", "GINIr", "p1", "p2", "p3"))
```


```{r tableGINI, results = "asis", warning = FALSE}

# create subsets
main_all  <- main[round == 10]
main_poor <- main[round == 10 & rich == FALSE]
main_rich <- main[round == 10 & rich == TRUE]

# create table
if(knitr::is_html_output()){
  type <- "html"
} else {
  type = "latex"
}

m1 <- lm(formula = gini ~ treatment, data = main_all)
m2 <- lm(formula = gini ~ treatment, data = main_poor)
m3 <- lm(formula = gini ~ treatment, data = main_rich)
stargazer(m1, m2, m3,

          column.labels = c("All", "Below median", "Above median"),
          model.numbers = FALSE,
          dep.var.labels = "Gini",
          header=FALSE,
          covariate.labels = c("Replication"),

          type = type, digits = 2, omit.stat = c("adj.rsq", "f"), df = FALSE
          )
```


```{r summary2, results = "asis", warning = FALSE}

if(knitr::is_html_output()){
  type <- "html"
} else {
  type = "latex"
}

replication <- main[treatment == "replication" & round == 10, gini]
GMTV    <- main[treatment == "noPunish10" & round == 10, gini]


rows <- sapply(X = list(replication, GMTV), FUN = NROW) %>% max()
temp <- data.frame(replication = c(replication, rep(NA, rows - NROW(replication))),
                   GMTV = c(GMTV, rep(NA, rows - NROW(GMTV))))

stargazer(temp,
          summary.stat = c("mean", "median","sd", "max", "min", "n"),
          type = type, 
          flip = TRUE, 
          header=FALSE)

rs2 <- wilcox.test(replication, 
                   GMTV,
                   exact = FALSE)$p.value %>% 
  round(digits = 4) %>% 
  formatC(format = "f", 
          digits = 4)

```

The rank sum test yields a p-Value of `r rs2` for the mean ```gini``` during the last period of the game.


## Sample Properties

```{r matchOutcomes}
covariates <- data.table::merge.data.table(x  = covs,
                                           y  = main[round == 10, .(groupID, stock, gini)],
                                           by = c("groupID"),
                                           allow.cartesian = TRUE)

covariates[,
           gender := gender %>% as.numeric()]

```

In addition to the summary statistics a regression table for each covariate as a dependent variable is needed. The independent variable will then be the data source (i.e. GMTV vs replication).

```{r summary3, results = "asis"}

# create table
if(knitr::is_html_output()){
  type <- "html"
} else {
  type = "latex"
}

temp <- covariates[treatment == "replication",
                   .(gender, age, switching_row, education, donation, pq01, pq02, pq03, pq04,
                     pq05, pq06, pq07, pq08, pq09, pq10, pq11, pq12, pq13, pq14)]
stargazer(temp, type = type, flip = FALSE)

```

```{r sampleDifferences1, results = "asis", warning = FALSE}

# create table
if(knitr::is_html_output()){
  type <- "html"
} else {
  type = "latex"
}

m1 <- lm(formula = gender ~ treatment, data = covs)
m2 <- lm(formula = age ~ treatment, data = covs)
m3 <- lm(formula = switching_row ~ treatment, data = covs)
m4 <- lm(formula = donation ~ treatment, data = covs)

stargazer(m1, m2, m3, m4,


          column.labels = c("female", "age", "risk", "donations"),
          model.numbers = FALSE,
          dep.var.labels.include = FALSE,
          header=FALSE,
          covariate.labels = c("Replication"),

          type = type, digits = 2, omit.stat = c("adj.rsq", "f"), df = FALSE
          )
```

```{r sampleDifferences2, results = "asis", warning = FALSE}

# create table
if(knitr::is_html_output()){
  type <- "html"
} else {
  type = "latex"
}

m1 <- lm(formula = pq01 ~ treatment, data = covs)
m2 <- lm(formula = pq02 ~ treatment, data = covs)
m3 <- lm(formula = pq03 ~ treatment, data = covs)
m4 <- lm(formula = pq04 ~ treatment, data = covs)
m5 <- lm(formula = pq05 ~ treatment, data = covs)

stargazer(m1, m2, m3, m4, m5,


          column.labels = c("quick thinker", "easily offended", "very satisfied", "very dependent", "generally happy"),
          model.numbers = FALSE,
          dep.var.labels.include = FALSE,
          header=FALSE,
          covariate.labels = c("Replication"),

          type = type, digits = 2, omit.stat = c("adj.rsq", "f"), df = FALSE
          )
```

```{r sampleDifferences3, results = "asis", warning = FALSE}

# create table
if(knitr::is_html_output()){
  type <- "html"
} else {
  type = "latex"
}

m1 <- lm(formula = pq06 ~ treatment, data = covs)
m2 <- lm(formula = pq07 ~ treatment, data = covs)
m3 <- lm(formula = pq08 ~ treatment, data = covs)
m4 <- lm(formula = pq09 ~ treatment, data = covs)
m5 <- lm(formula = pq10 ~ treatment, data = covs)

stargazer(m1, m2, m3, m4, m5,


          column.labels = c("work important", "family important", "friends important", "religion important", "politics important"),
          model.numbers = FALSE,
          dep.var.labels.include = FALSE,
          header=FALSE,
          covariate.labels = c("Replication"),

          type = type, digits = 2, omit.stat = c("adj.rsq", "f"), df = FALSE
          )
```

```{r sampleDifferences4, results = "asis", warning = FALSE}

# create table
if(knitr::is_html_output()){
  type <- "html"
} else {
  type = "latex"
}

m1 <- lm(formula = pq11 ~ treatment, data = covs)
m2 <- lm(formula = pq12 ~ treatment, data = covs)
m3 <- lm(formula = pq13 ~ treatment, data = covs)
m4 <- lm(formula = pq14 ~ treatment, data = covs)

stargazer(m1, m2, m3, m4,


          column.labels = c("most people trusted", "hard work better", "government responsible", "incomes equal"),
          model.numbers = FALSE,
          dep.var.labels.include = FALSE,
          header=FALSE,
          covariate.labels = c("Replication"),

          type = type, digits = 2, omit.stat = c("adj.rsq", "f"), df = FALSE
          )
```

```{r tableCovariates, results = "asis", warning = FALSE}

# create table
if(knitr::is_html_output()){
  type <- "html"
} else {
  type = "latex"
}

olsStock1 <- lm(formula = stock ~ gender + age + switching_row + pq01 + pq02 + pq03 + pq04 + 
                  pq05 + pq06 + pq07 +pq08 + pq09 + pq10 + pq11 + pq12 + pq13 + pq14, 
                data = covariates[treatment == "replication"])
olsStock2  <- lm(formula = stock ~ gender + age + switching_row,
                data = covariates[treatment == "replication"])
olsGINI1  <- lm(formula = gini ~ gender + age + switching_row + pq01 + pq02 + pq03 + pq04 +
                  pq05 + pq06 + pq07 + pq08 + pq09 + pq10 + pq11 + pq12 + pq13 + pq14, 
                data = covariates[treatment == "replication"])
olsGINI2  <- lm(formula = gini ~ gender + age + switching_row,
                data = covariates[treatment == "replication"])

stargazer(olsStock1, olsStock2,
          olsGINI1, olsGINI2,
          
          se = list(coef(summary(olsStock1, cluster = c("groupID")))[, 2],
                    coef(summary(olsStock2, cluster = c("groupID")))[, 2],
                    coef(summary(olsGINI1,  cluster = c("groupID")))[, 2],
                    coef(summary(olsGINI2,  cluster = c("groupID")))[, 2]),

          column.labels   = c("Wealth", "Gini"),
          dep.var.labels.include = FALSE,
          column.separate = c(2, 2),
          model.numbers = FALSE,
          header=FALSE,
          covariate.labels = c("female", "age", "risk",
                               "quick thinker",
                               "easily offended",
                               "very satisfied",
                               "very dependent",
                               "generally happy",
                               "work important",
                               "family important",
                               "friends important",
                               "religion important",
                               "politics important",
                               "most people trusted",
                               "hard work better",
                               "government responsible",
                               "incomes equal"),
          notes = "Robust standard errors in parentheses, clustered by group ID.",

          type = type, digits = 2, omit.stat = c("adj.rsq", "f"), df = FALSE
          )
```