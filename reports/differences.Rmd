---
title: "Growth & Inequality in Dynamic Public Goods Games"
description: |
  Reproducing Gächter et al.'s main findings.
author:
  - name: Hauke Roggenkamp 
    url: https://github.com/Howquez
    affiliation: CLICCS
    affiliation_url: https://www.cliccs.uni-hamburg.de/
date: "`r Sys.Date()`"
bibliography: biblio.bib
output:
  distill::distill_article:
    toc: true
    toc_depth: 2
    toc_float: false
    code_folding: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(haven)
library(data.table)
library(magrittr)
library(kableExtra)
library(DescTools) # gini coefficient
library(downloadthis)
library(stringr)
# library(Rmisc)
library(ggplot2)
library(highcharter)
library(wesanderson)
library(patchwork)
library(sjPlot)

GMTV <- read_dta(file="../data/gaechteretal/GMTV-data.dta") %>% data.table()
```


# Introduction 

In an attempt to incorporate uncertainty to @GACHTER2017's dynamic public goods game (DPGG), I plan to run a series of remote online experiments using oTree [@oTree]. The first experiment will replicate Gächter et al.'s NOPUNISH 10-period version as close as possible (given the remote circumstances). The current demo version of the experiment can be found [here](https://cliccs.herokuapp.com/). Click [here](https://github.com/Howquez/coopUncertainty) to visit the corresponding Github repository.

This document explores the data provided by @GACHTER2017 and finds that some of the variables are a little off. In addition, it fails to replicate the orginal article's figures. The following chapter will describe the available data. Subsequently, [data excerpts](#Tables) will demonstrate that the original _Gini coefficient_ varies within groups (in selected periods) and the _share of current endowment contributed_ is calculated using the last round's endowment. [Afterwards](#Downloads), the data is processsed and made available for downloads.The [Visualizations](#Visualizations) chapter will then present the original figures as well as figures reproduced using the original and re-calculated variables to demonstrate differences.


# Original Data

## Description

The data can be found in the supplementary materials they provide in the [online appendix](https://www.sciencedirect.com/science/article/pii/S0047272717300361#s0115) and contains, among others, the following variables:

- ```exp_num``` is a session identifier
- ```per``` denotes the period
- ```gr_id``` is a group identifier (carrying treatment information)
- ```subj_id``` is a subject identifier
- ```tokens``` reports a subject's endowment in a period
- ```other[1-3]``` report the other group members' endowments in a period
- ```gdp ``` equals the sum of endowments of a group in a period
- ```putin``` reports a subject's contribution in a period
- ```pu[1-3]``` report the other group members' contributions in a period
- ```sum``` equals the sum of contributions of a group in a period
- ```gini``` reports a group's Gini coefficient in a period
- ```mean``` reports the fraction of sum/lagged(gdp)
- ```totallost``` ?

I add three new measures,namely: ```gini2```, ```mean2``` and ```gpd2```. ```gini2``` differs from the original as it is constant within groups. ```mean2``` is equivalent to the original ```mean``` but relies on the current ```gdp``` instead of the lagged one. In addition to the ```gpd``` (stating the endowment at the beginning of a period), I calculate ```gpd2``` for the noPunish treatments and thereby report the income at the end of a period. Finally, I create a ```treatment``` string-variable .


```{r createVars, include = FALSE}
# treatments

  GMTV[punish == 0 & longgame == 0, # exp_num == 5 | exp_num == 8 | exp_num == 9,
       treatment := "noPunish10"]
  
  GMTV[punish == 0 & longgame == 1, # exp_num == 1 | exp_num == 3,
       treatment := "noPunish15"]
  
  GMTV[punish == 1 & longgame == 0, # exp_num == 4 | exp_num == 6 | exp_num == 10,
       treatment := "Punish10"]
  
  GMTV[punish == 1 & longgame == 1, # exp_num == 2 | exp_num == 7,
       treatment := "Punish15"]

# gdp, mean & gini
  GMTV[treatment == "noPunish10" | treatment == "noPunish15",
       gdp2 := (gdp + ceiling(sum/4*1.5)*4-sum)]
  
  GMTV[,
       mean2 := sum/gdp]
  
  GMTV[,
       gini2 := Gini(c(tokens, other1, other2, other3)),
       by = .(treatment, gr_id, per)]
  
# rearrange & subset
GMTV <- GMTV[order(treatment, gr_id, per),
             .(treatment, treat, punish, longgame,        # treatment vars 
               exp_num, gr_id, per, subj_id,              # IDs
               tokens, other1, other2, other3, gdp, gdp2, # endowments
               putin, pu1, pu2, pu3, sum, mean, mean2,    # contributions
               gini, gini2,                               # ginis
               totallost,                                 # punishment var
               highgdp
              )]
```


## Excerpts {#Tables}

The first few rows of the resulting data look as follows:

```{r showData, layout = "l-body-outset"}

GMTV[gr_id == 501] %>% 
  head(n = 10) %>%
  kbl() %>% 
  kable_paper("hover", 
              full_width = TRUE,
              fixed_thead = TRUE)

```

The Table shows group 501 in the first two periods where subjects 511 to 514 start with an initial endowment of 20 which makes a GDP of 80. Subject 511 does not contribute (as represented in ```putin==0``` in the first row and ```pu1==0```in rows 2 to 4) while the others contribute 5, 15 and 15 in the first period, respectively. The ```sum``` of contributions therefore equals 35 period 1.

With a sum of contributions being 35 and a return of contributions of 1.5, each subject receives ```ceil(13.125)``` =14 points from the group project such that the next period's ```gdp``` equals 101.

The Gini coefficient (```gini```) is a little off as one can see in the second period: Even though this is a group level variable, the group has three different coefficient levels in the same period. 

The mean is calculated such that it can be interpreted as the _share of past endowments contributed_. This differs from the interpretation in the paper's [Figure 1 Panel (b)](https://www.sciencedirect.com/science/article/pii/S0047272717300361#f0005). Furthermore, the ```mean``` can take values greater than one which becomes  clear if one focuses on group 402 in the Table below:

```{r showData2, layout = "l-body-outset"}

GMTV[gr_id == 402 & per > 4] %>% 
  head(n = 8) %>%
  kbl() %>% 
  kable_paper("hover", 
              full_width = TRUE,
              fixed_thead = TRUE)

```

The Table above shows the group members contributing almost all of their current endowments, which leads to significant growth. Using the lagged ```gdp``` as a denominator, the ```mean``` is larger than 1 and thus, considerably greater than _share of current endowment contributed_ could possibly be.

# Data Processing {#Downloads}

To reproduce the main visualizations of the paper, I change the unit of observations to groups such that subject-level variables will be dropped. Because the ```gini``` has shown to differ within groups and periods, I 'll report its average in what follows. Furthermore, I'll subset the data and only consider the first ten, that is, the original experiment-sessions.

```{r aggregateData, layout = "l-body-outset"}

# set gini to group average
GMTV[,
     gini := mean(gini, na.rm = TRUE),
     by = c("treatment", "exp_num", "gr_id", "per")]

# remove duplicate rows while subsetting only group level variables
GMTVgroups <- GMTV[exp_num <= 10,
                   .(treatment,
                     treat,
                     punish = as.logical(punish),
                     longgame = as.logical(longgame),
                     exp_num,
                     gr_id,
                     per,
                     sum,
                     gdp,
                     mean,
                     mean2,
                     gini,
                     gini2,
                     highgdp = as.logical(highgdp))] %>% unique()

# show
GMTVgroups %>%
  head(n = 10) %>%
  kbl() %>% 
  kable_paper("hover", 
              full_width = TRUE,
              fixed_thead = TRUE)

```

You can download the data here:

```{r downloadData}
GMTV %>%
      download_this(
        output_name = "GMTV_individuals",
        output_extension = ".csv", # CSV output
        button_label = "individual data",
        button_type = "default"
        )

GMTVgroups %>%
      download_this(
        output_name = "GMTV_groups",
        output_extension = ".csv", # CSV output
        button_label = "group data",
        button_type = "default"
        )
```

# Figures

The following code chunks aim to reproduce some of the panels presented in the original paper's figures. Reproducing [Figure 2 Panel (a)](https://www.sciencedirect.com/science/article/pii/S0047272717300361#f0010) is relatively simple as the corresponding ```gdp``` is free of doubt. The ```mean``` and ```gini``` in contrast, need some [additional attention](#Visualizations).

```{r}
layout <- theme(panel.background = element_rect(fill = "white"),
                panel.grid = element_line(colour="gray", size=0),
                panel.grid.major.y = element_line(colour="gray", size=0.25),
                legend.key = element_rect(fill = "white"),
                axis.line.x.bottom = element_line(size = 0.25),
                axis.line.y.left = element_line(size = 0.25),
                # plot.margin = unit(c(1,1,1,1), "cm"),
                legend.title = element_blank()
                )
```

## Pure Reproductions?

![Original Figure 2 (a)](../gaechterSupplementaryMaterials/Figures/Figure2a.jpeg)

```{r plotGDP, layout="l-body", fig.cap="Figure 2 (a) using original data"}

GDP <- GMTVgroups[,
                    lapply(.SD, mean, na.rm = TRUE),
                    by = c("per", "treatment", "punish", "longgame"),
                    .SDcols = "gdp"]

GDP[,
    gdp := round(gdp)]

hchart(GDP, "line", hcaes(x = per, y = gdp, group = treatment),
       dashStyle = c("solid", "solid", "longdash", "longdash")) %>%
  hc_yAxis(title = list(text = "Wealth"),
           min = 0, max = 3100, minTickInterval = 500) %>%
  hc_xAxis(title = list(text = "Period"),
           min = 0, max = 15, minTickInterval = 1,
           plotLines = list(list(
    value = 10
  ))) %>%
  hc_tooltip(shared = TRUE, headerFormat = "Period {point.key} <br>") %>%
  hc_colors(wes_palette("Zissou1")[1:4])

```

```{r plotStaticGDP, include = FALSE, layout="l-body"}
ggplot(data = GDP, aes(x = per, y = gdp, fill = treatment, color = treatment, lty = punish)) +
          layout +
          theme(legend.position="bottom") +
          geom_vline(xintercept = 10, alpha = 0.66) +
          geom_line(show.legend=FALSE) +
          geom_point() +
          scale_x_continuous(name="",  breaks = 1:15) +
          scale_y_continuous(breaks = seq(0, 3000, by = 500), limits = c(0, 3100), expand = c(0, 0)) +
          labs(y = "Wealth") +
          scale_color_manual(values = wes_palette("Zissou1"))
```


![Original Figure 1 (a)](../gaechterSupplementaryMaterials/Figures/Figure1a.jpeg)

```{r plotSum, layout="l-body", fig.cap="Figure 1 (a) using original data"}

SUM <- GMTVgroups[,
                    lapply(.SD, mean, na.rm = TRUE),
                    by = c("per", "treatment", "punish", "longgame"),
                    .SDcols = "sum"]

SUM[,
    sum := round(sum/4)]

hchart(SUM, "line", hcaes(x = per, y = sum, group = treatment),
       dashStyle = c("solid", "solid", "longdash", "longdash")) %>%
  hc_yAxis(title = list(text = "Average Amount of Tokens contributed"),
           min = 0, max = 150, minTickInterval = 50) %>%
  hc_xAxis(title = list(text = "Period"),
           min = 0, max = 15, minTickInterval = 1,
           plotLines = list(list(
    value = 10
  ))) %>%
  hc_tooltip(shared = TRUE, headerFormat = "Period {point.key} <br>") %>%
  hc_colors(wes_palette("Zissou1")[1:4])

```

```{r plotStaticSum, include = FALSE, layout="l-body"}
ggplot(data = SUM, aes(x = per, y = sum, fill = treatment, color = treatment, lty = punish)) +
          layout +
          theme(legend.position="bottom") +
          geom_vline(xintercept = 10, alpha = 0.66) +
          geom_line(show.legend=FALSE) +
          geom_point() +
          scale_x_continuous(name="",  breaks = 1:15) +
          scale_y_continuous(breaks = seq(0, 150, by = 50), limits = c(0, 170), expand = c(0, 0)) +
          labs(y = "Average Amount of Tokens contributed") +
          scale_color_manual(values = wes_palette("Zissou1"))
```


## Implications {#Visualizations}

What changes if one defines the ```mean``` as well as the ```gini``` differently? The following Figure illustrates the share of past endowments contributed in the left panel as well as the share of current endowments contributed in the right panel. Both panels correspond to [Figure 1 Panel (b)](https://www.sciencedirect.com/science/article/pii/S0047272717300361#f0005) and illustrate the share over time.

![Original Figure 1 (b)](../gaechterSupplementaryMaterials/Figures/Figure1b.jpeg)


```{r plotMean, layout="l-body", fig.cap="Figure 1 (b) using original data"}
means <- GMTVgroups[,
                    lapply(.SD, mean, na.rm = TRUE),
                    by = c("per", "treatment", "punish", "longgame"),
                    .SDcols = c("mean", "mean2")]

means[, mean := round(mean, digits = 2)]
means[, mean2 := round(mean2, digits = 2)]

# plots
mean <- hchart(means, "line", hcaes(x = per, y = mean, group = treatment),
               dashStyle = c("solid", "solid", "longdash", "longdash")) %>%
  hc_yAxis(title = list(text = "Share of Past Endowment contributed"),
           min = 0, max = 1.1, minTickInterval = 0.2) %>%
  hc_xAxis(title = list(text = "Period"),
           min = 0, max = 15, minTickInterval = 1,
           plotLines = list(list(
    value = 10
  ))) %>%
  hc_tooltip(shared = TRUE, headerFormat = "Period {point.key} <br>") %>%
  hc_colors(wes_palette("Zissou1")[1:4])

mean
```

```{r  plotMean2, layout="l-body", fig.cap="Figure 1 (b) using re-calculated data"}

mean2 <- hchart(means, "line", hcaes(x = per, y = mean2, group = treatment),
               dashStyle = c("solid", "solid", "longdash", "longdash")) %>%
  hc_yAxis(title = list(text = "Share of Current Endowment contributed"),
           min = 0, max = 1.1, minTickInterval = 0.2) %>%
  hc_xAxis(title = list(text = "Period"),
           min = 0, max = 15, minTickInterval = 1,
           plotLines = list(list(
    value = 10
  ))) %>%
  hc_tooltip(shared = TRUE, headerFormat = "Period {point.key} <br>") %>%
  hc_colors(wes_palette("Zissou1")[1:4])

mean2
```
 
```{r plotMeans, include = FALSE}
# view
hw_grid(
  mean, mean2,
  ncol = 2,
  rowheight = NULL,
  add_htmlgrid_css = TRUE,
  browsable = TRUE
)
```


```{r plotStaticMeans, include = FALSE, layout="l-body"}
mean <- ggplot(data = means, aes(x = per, y = mean, fill = treatment, color = treatment, lty = punish)) +
          layout +
          theme(legend.position="none") +
          geom_vline(xintercept = 10, alpha = 0.66) +
          geom_line(show.legend=FALSE) +
          geom_point() +
          scale_x_continuous(name="",  breaks = 1:15) +
          scale_y_continuous(breaks = seq(0, 1, by = 0.2), limits = c(0, 1.1), expand = c(0, 0)) +
          labs(y = "Share of Endowment contributed") +
          scale_color_manual(values = wes_palette("Zissou1"))

mean2 <- ggplot(data = means, aes(x = per, y = mean2, fill = treatment, color = treatment, lty = punish)) +
          layout +
          theme(legend.position="none") +
          geom_vline(xintercept = 10, alpha = 0.66) +
          geom_line(show.legend=FALSE) +
          geom_point() +
          scale_x_continuous(name="", breaks = 1:15) +
          scale_y_continuous(breaks = seq(0, 1, by = 0.2), limits = c(0, 1.1), expand = c(0, 0)) +
          labs(y = "") +
          scale_color_manual(values = wes_palette("Zissou1"))

patchwork <- mean + mean2 & theme(legend.position = "bottom")
patchwork <- patchwork + plot_layout(guides = "collect")
patchwork
```

Note that there are some groups in the punishment treatments that (almost) went bankrupt. Having endowments of one or two tokens, even low contributions become _relatively_ large. This may drive differences between treatments in any measure of the _share of endowments contributed_.

Just as in [Figure 3 Panel (a)](https://www.sciencedirect.com/science/article/pii/S0047272717300361#f0015), the following figure illustrates the two Gini coefficients over time. The left panel visualizes the group-level mean of original variable, while the right panel shows the re-calculated one.

![Original Figure 3 (a)](../gaechterSupplementaryMaterials/Figures/Figure3a.jpeg)


```{r plotGini, layout="l-body", fig.cap="Figure 3 (a) using original data"}
ginis <- GMTVgroups[,
                    lapply(.SD, mean, na.rm = TRUE),
                    by = c("per", "treatment", "punish", "longgame"),
                    .SDcols = c("gini", "gini2")]

ginis[, gini := round(gini, digits = 2)]
ginis[, gini2 := round(gini2, digits = 2)]

# plots
gini <- hchart(ginis, "line", hcaes(x = per, y = gini, group = treatment),
               dashStyle = c("solid", "solid", "longdash", "longdash")) %>%
  hc_yAxis(title = list(text = "Original Gini Coefficients"),
           min = 0, max = 0.4, minTickInterval = 0.1) %>%
  hc_xAxis(title = list(text = "Period"),
           min = 0, max = 15, minTickInterval = 1,
           plotLines = list(list(
    value = 10
  ))) %>%
  hc_tooltip(shared = TRUE, headerFormat = "Period {point.key} <br>") %>%
  hc_colors(wes_palette("Zissou1")[1:4])

gini
```

```{r plotGini2, layout="l-body", fig.cap="Figure 3 (a) using re-calculated data"}

gini2 <- hchart(ginis, "line", hcaes(x = per, y = gini2, group = treatment),
               dashStyle = c("solid", "solid", "longdash", "longdash")) %>%
  hc_yAxis(title = list(text = "Re-calculated Gini Coefficients"),
           min = 0, max = 0.4, minTickInterval = 0.1) %>%
  hc_xAxis(title = list(text = "Period"),
           min = 0, max = 15, minTickInterval = 1,
           plotLines = list(list(
    value = 10
  ))) %>%
  hc_tooltip(shared = TRUE, headerFormat = "Period {point.key} <br>") %>%
  hc_colors(wes_palette("Zissou1")[1:4])

gini2
```


```{r plotGinis, include = FALSE}

# view 
# hw_grid(
#   gini, gini2,
#   ncol = 2,
#   rowheight = NULL,
#   add_htmlgrid_css = TRUE,
#   browsable = TRUE
# )

```

```{r plotStaticGinis, include = FALSE, layout="l-body"}
# plot
gini <- ggplot(data = ginis, aes(x = per, y = gini, fill = treatment, color = treatment, lty = punish)) +
          layout +
          theme(legend.position="none") +
          geom_vline(xintercept = 10, alpha = 0.66) +
          geom_line(show.legend=FALSE) +
          geom_point() +
          scale_x_continuous(name="",  breaks = 1:15) +
          scale_y_continuous(breaks = seq(0, 0.4, by = 0.1), limits = c(0, 0.4), expand = c(0, 0)) +
          labs(y = "Gini coefficient") +
          scale_color_manual(values = wes_palette("Zissou1"))

gini2 <- ggplot(data = ginis, aes(x = per, y = gini2, fill = treatment, color = treatment, lty = punish)) +
          layout +
          theme(legend.position="none") +
          geom_vline(xintercept = 10, alpha = 0.66) +
          geom_line(show.legend=FALSE) +
          geom_point() +
          scale_x_continuous(name="", breaks = 1:15) +
          scale_y_continuous(breaks = seq(0, 0.4, by = 0.1), limits = c(0, 0.4), expand = c(0, 0)) +
          labs(y = "") +
          scale_color_manual(values = wes_palette("Zissou1"))

patchwork <- gini + gini2 & theme(legend.position = "bottom")
patchwork <- patchwork + plot_layout(guides = "collect")
patchwork
```

# Tables

Table 2: OLS Regression Wealth ✅

```{r olsWealth}
m2.1  <- lm(gdp ~ punish, data = GMTVgroups[longgame == 0 & treat < 3 & per == 10])
m2.2  <- lm(gdp ~ punish, data = GMTVgroups[longgame == 0 & treat < 3 & per == 10 & highgdp == 0])
m2.3  <- lm(gdp ~ punish, data = GMTVgroups[longgame == 0 & treat < 3 & per == 10 & highgdp == 1])

m2.4  <- lm(gdp ~ punish, data = GMTVgroups[longgame == 1 & treat > 100 & per == 15])
m2.5  <- lm(gdp ~ punish, data = GMTVgroups[longgame == 1 & treat > 100 & per == 15 & highgdp == 0])
m2.6  <- lm(gdp ~ punish, data = GMTVgroups[longgame == 1 & treat > 100 & per == 15 & highgdp == 1])

tab_model(m2.1, m2.2, m2.3, m2.4, m2.5, m2.6,
          dv.labels = c("10All", "10Below", "10Above", "15All", "15Below", "15Above"),
          p.style = "stars",
          show.ci = FALSE,
          show.p = FALSE, 
          transform = NULL)
```

Table 3: OLS Regression Gini ✅

```{r olsGini}

m3.1  <- lm(gini ~ punish, data = GMTVgroups[longgame == 0 & treat < 3 & per == 10])
m3.2  <- lm(gini ~ punish, data = GMTVgroups[longgame == 0 & treat < 3 & per == 10 & highgdp == 0])
m3.3  <- lm(gini ~ punish, data = GMTVgroups[longgame == 0 & treat < 3 & per == 10 & highgdp == 1])

m3.4  <- lm(gini ~ punish, data = GMTVgroups[longgame == 1 & treat > 100 & per == 15])
m3.5  <- lm(gini ~ punish, data = GMTVgroups[longgame == 1 & treat > 100 & per == 15 & highgdp == 0])
m3.6  <- lm(gini ~ punish, data = GMTVgroups[longgame == 1 & treat > 100 & per == 15 & highgdp == 1])

tab_model(m3.1, m3.2, m3.3, m3.4, m3.5, m3.6,
          dv.labels = c("10All", "10Below", "10Above", "15All", "15Below", "15Above"),
          p.style = "stars",
          show.ci = FALSE,
          show.p = FALSE, 
          transform = NULL)
```

Table 3: OLS Regression re-calculated Gini

```{r olsGini2}

m4.1  <- lm(gini2 ~ punish, data = GMTVgroups[longgame == 0 & treat < 3 & per == 10])
m4.2  <- lm(gini2 ~ punish, data = GMTVgroups[longgame == 0 & treat < 3 & per == 10 & highgdp == 0])
m4.3  <- lm(gini2 ~ punish, data = GMTVgroups[longgame == 0 & treat < 3 & per == 10 & highgdp == 1])

m4.4  <- lm(gini2 ~ punish, data = GMTVgroups[longgame == 1 & treat > 100 & per == 15])
m4.5  <- lm(gini2 ~ punish, data = GMTVgroups[longgame == 1 & treat > 100 & per == 15 & highgdp == 0])
m4.6  <- lm(gini2 ~ punish, data = GMTVgroups[longgame == 1 & treat > 100 & per == 15 & highgdp == 1])

tab_model(m4.1, m4.2, m4.3, m4.4, m4.5, m4.6,
          dv.labels = c("10All", "10Below", "10Above", "15All", "15Below", "15Above"),
          p.style = "stars",
          show.ci = FALSE,
          show.p = FALSE, 
          transform = NULL)
```