---
title: "3. Analyses Plan"
description: |
  Analyze and compare data
author:
  - name: Hauke Roggenkamp 
    url: https://github.com/Howquez
    affiliation: CLICCS
    affiliation_url: https://www.cliccs.uni-hamburg.de/
date: "`r Sys.Date()`"
bibliography: biblio.bib
output:
  distill::distill_article:
    toc: true
    toc_depth: 2
    toc_float: false
    code_folding: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(data.table)
library(magrittr)
library(kableExtra)
library(downloadthis)
library(ggplot2)
library(wesanderson)
library(patchwork)
library(stargazer)
```


# Background 

In an attempt to incorporate uncertainty to @GACHTER2017's dynamic public goods game (DPGG), I plan to run a series of remote online experiments using oTree [@oTree]. The first experiment will replicate GÃ¤chter et al.'s NOPUNISH 10-period version as close as possible (given the remote circumstances). The current demo version of the experiment can be found [here](https://cliccs.herokuapp.com/). Click [here](https://github.com/Howquez/coopUncertainty) to visit the corresponding Github repository.

This report is the third in a series of reports covering this project. It reads the data prepared in the previous reports and analyzes them.

```{r readData}
load(file="../data/processed/rda/GMTV2017.rda")          # read GMTV
load(file="../data/processed/rda/GMTV2017_R1.rda")       # read GMTVFirstRound
load(file="../data/processed/rda/GMTV2017_COVS.rda")     # read GMTVCovariates
load(file="../data/processed/rda/replication2021.rda")       # read replication
load(file="../data/processed/rda/replication2021_R1.rda")    # read replicationFirstRound
load(file="../data/processed/rda/replication2021_COVS.rda")  # read replicationCovariates
```

```{r cbind}
main <- rbindlist(list(replication, GMTV), 
                  use.names = TRUE)

R1   <- rbindlist(list(replicationFirstRound, GMTVFirstRound), 
                  use.names = TRUE)

covs <- rbindlist(list(replicationCovariates, GMTVCovariates), 
                  use.names = TRUE,
                  fill = TRUE)

rm(list = c("replication", "GMTV", "replicationFirstRound", "GMTVFirstRound", "GMTVCovariates", "replicationCovariates"))
```


# Results

```{r layout}
layout <- theme(panel.background = element_rect(fill = "white"),
                panel.grid = element_line(colour="gray", size=0),
                panel.grid.major.y = element_line(colour="gray", size=0.25),
                legend.key = element_rect(fill = "white"),
                axis.line.x.bottom = element_line(size = 0.25),
                axis.line.y.left = element_line(size = 0.25),
                axis.title.y = element_text(size = rel(0.75)),
                plot.margin = margin(c(0.25,0.25,0.25,0.25), "cm"),
                legend.title = element_blank()
                )
```


## First Round

```{r firstRound, eval = FALSE}
ggplot(R1, aes(y=othersContribution, x=belief)) +
  layout +
  geom_abline(intercept = 0, slope = 1, linetype="dashed", alpha = 0.66) +
  geom_point() +
  geom_point(color = wes_palette("Moonrise3")[1]) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 60)) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 60))

ggplot(R1, aes(y=ownContribution, x=belief/3)) +
  layout +
  geom_abline(intercept = 0, slope = 1, linetype="dashed", alpha = 0.66)+ 
  geom_point() +
  geom_point(color = wes_palette("Moonrise3")[1]) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 25)) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 25))

ggplot(R1, aes(y=ownContribution, x=othersContribution/3)) +
  layout +
  geom_abline(intercept = 0, slope = 1, linetype="dashed", alpha = 0.66) +
  geom_point(color = wes_palette("Moonrise3")[1]) +
  scale_y_continuous(expand = c(0, 0), limits = c(-1, 25)) +
  scale_x_continuous(expand = c(0, 0), limits = c(-1, 25))
  
```

## Provision of the public good and wealth creation

```{r plotContributions}

SUM <- main[,
            lapply(.SD, mean, na.rm = TRUE),
            by = c("round", "treatment"),
            .SDcols = "contribution"]

SUM[,
    sum := round(contribution/4)]

upperLimit <- SUM$contribution %>% max() %>% round() + 10

p1 <- ggplot(data = SUM, 
             aes(x = round, y = contribution, fill = treatment, color = treatment, lty = treatment)) +
  layout +
  theme(legend.position="bottom") +
  geom_line(show.legend=FALSE) +
  geom_point() +
  scale_x_continuous(name="",  breaks = 1:15) +
  scale_y_continuous(limits = c(0, upperLimit), expand = c(0, 0)) +
  labs(y = "Average Amount of Tokens contributed") +
  scale_color_manual(values = wes_palette("GrandBudapest1")) + 
  theme(plot.margin = margin(0.25,1,0.25,0.25, "cm"))

rm(list = c("SUM"))
```


```{r plotShareOfContributions, fig.cap = "The average amount of tokens contributed over time in treatments."}

SHARE <- main[,
            lapply(.SD, mean, na.rm = TRUE),
            by = c("round", "treatment"),
            .SDcols = "share"]

upperLimit <- 1

p2 <- ggplot(data = SHARE, 
             aes(x = round, y = share, fill = treatment, color = treatment, lty = treatment)) +
  layout +
  theme(legend.position="bottom") +
  geom_line(show.legend=FALSE) +
  geom_point() +
  scale_x_continuous(name="",  breaks = 1:15) +
  scale_y_continuous(limits = c(0, upperLimit), expand = c(0, 0)) +
  labs(y = "Share of Current Endowment contributed") +
  scale_color_manual(values = wes_palette("GrandBudapest1"))

p1 + p2 + plot_layout(guides = "collect") & theme(legend.position = "bottom")

rm(list = c("SHARE", "p1", "p2"))
```


```{r summary1, results = "asis", warning = FALSE, fig.cap = "test"}

if(knitr::is_html_output()){
  type <- "html"
} else {
  type = "latex"
}

replication <- main[treatment == "replication" & round == 10, stock]
GMTV    <- main[treatment == "noPunish10" & round == 10, stock]


rows <- sapply(X = list(replication, GMTV), FUN = NROW) %>% max()
temp <- data.frame(replication = c(replication, rep(NA, rows - NROW(replication))),
                   GMTV = c(GMTV, rep(NA, rows - NROW(GMTV))))

stargazer(temp,
          summary.stat = c("mean", "median","sd", "max", "min", "n"),
          type = type, 
          flip = TRUE, 
          header=FALSE)

rs1 <- wilcox.test(replication, GMTV)$p.value %>% round(digits = 4) %>% formatC(format = "f", digits = 4)

```

The rank sum test yields a p-Value of `r rs1` for the mean ```stock``` a.k.a _Wealth_ during the last period of the game.


```{r tableStock, results = "asis", warning = FALSE}

# create subsets
main_all  <- main[round == 10]
main_poor <- main[round == 10 & rich == FALSE]
main_rich <- main[round == 10 & rich == TRUE]

# create table
if(knitr::is_html_output()){
  type <- "html"
} else {
  type = "latex"
}

stargazer(lm(formula = stock ~ treatment, data = main_all),
          lm(formula = stock ~ treatment, data = main_poor),
          lm(formula = stock ~ treatment, data = main_rich),

          column.labels = c("All", "Below median", "Above median"),
          model.numbers = FALSE,
          dep.var.labels = "Wealth",
          header=FALSE,
          covariate.labels = c("Replication"),

          type = type, digits = 2, omit.stat = c("adj.rsq", "f"), df = FALSE
          )
```

```{r plotStock, fig.cap = "Average wealth over time across treatments."}
STOCK <- main[,
              lapply(.SD, mean, na.rm = TRUE),
              by = c("round", "treatment"),
              .SDcols = "stock"]

STOCKr <- main[rich == TRUE,
               lapply(.SD, mean, na.rm = TRUE),
               by = c("round", "treatment"),
               .SDcols = "stock"]

STOCKp <- main[rich == FALSE,
               lapply(.SD, mean, na.rm = TRUE),
               by = c("round", "treatment"),
               .SDcols = "stock"]

upperLimit <- STOCKr$stock %>% max() %>% round() + 20

p1 <- ggplot(data = STOCK, 
       aes(x = round, y = stock, fill = treatment, color = treatment, lty = treatment)) +
          layout +
          theme(legend.position="bottom") +
          # geom_vline(xintercept = 10, alpha = 0.66) +
          geom_line(show.legend=FALSE) +
          geom_point() +
          scale_x_continuous(name="",  breaks = 1:10) +
          scale_y_continuous(limits = c(0, upperLimit), expand = c(0, 0)) +
          labs(y = "Wealth") +
          scale_color_manual(values = wes_palette("GrandBudapest1")) + 
          theme(plot.margin = margin(0.25,1,0.25,0.25, "cm"))

p2 <- ggplot(data = STOCKr, 
       aes(x = round, y = stock, fill = treatment, color = treatment, lty = treatment)) +
          layout +
          theme(legend.position="bottom") +
          # geom_vline(xintercept = 10, alpha = 0.66) +
          geom_line(show.legend=FALSE) +
          geom_point() +
          scale_x_continuous(name="",  breaks = 1:10) +
          scale_y_continuous(limits = c(0, upperLimit), expand = c(0, 0)) +
          labs(y = "Wealth (Rich)") +
          scale_color_manual(values = wes_palette("GrandBudapest1"))

p3 <- ggplot(data = STOCKp, 
       aes(x = round, y = stock, fill = treatment, color = treatment, lty = treatment)) +
          layout +
          theme(legend.position="bottom") +
          # geom_vline(xintercept = 10, alpha = 0.66) +
          geom_line(show.legend=FALSE) +
          geom_point() +
          scale_x_continuous(name="",  breaks = 1:10) +
          scale_y_continuous(limits = c(0, upperLimit), expand = c(0, 0)) +
          labs(y = "Wealth (Poor)") +
          scale_color_manual(values = wes_palette("GrandBudapest1"))

(p1 | (p2 / p3)) + plot_layout(guides = "collect") & theme(legend.position = "bottom")

rm(list = c("STOCK", "STOCKr", "STOCKp", "p1", "p2", "p3"))
```


## Inequality

```{r plotInequality, fig.cap = "Average Gini coefficient over time across treatments."}
GINI <- main[,
             lapply(.SD, mean, na.rm = TRUE),
             by = c("round", "treatment"),
             .SDcols = "gini"]

GINIr <- main[rich == TRUE,
              lapply(.SD, mean, na.rm = TRUE),
              by = c("round", "treatment"),
              .SDcols = "gini"]

GINIp <- main[rich == FALSE,
              lapply(.SD, mean, na.rm = TRUE),
              by = c("round", "treatment"),
              .SDcols = "gini"]

upperLimit <- GINI$gini %>% max() %>% round(digits = 1) + 0.10

p1 <- ggplot(data = GINI, 
       aes(x = round, y = gini, fill = treatment, color = treatment, lty = treatment)) +
          layout +
          theme(legend.position="bottom") +
          # geom_vline(xintercept = 10, alpha = 0.66) +
          geom_line(show.legend=FALSE) +
          geom_point() +
          scale_x_continuous(name="",  breaks = 1:10) +
          scale_y_continuous(limits = c(0, upperLimit), expand = c(0, 0)) +
          labs(y = "Gini Coefficient") +
          scale_color_manual(values = wes_palette("GrandBudapest1")) + 
          theme(plot.margin = margin(0.25,1,0.25,0.25, "cm"))

p2 <- ggplot(data = GINIr, 
       aes(x = round, y = gini, fill = treatment, color = treatment, lty = treatment)) +
          layout +
          theme(legend.position="bottom") +
          # geom_vline(xintercept = 10, alpha = 0.66) +
          geom_line(show.legend=FALSE) +
          geom_point() +
          scale_x_continuous(name="",  breaks = 1:10) +
          scale_y_continuous(limits = c(0, upperLimit), expand = c(0, 0)) +
          labs(y = "Gini (Rich)") +
          scale_color_manual(values = wes_palette("GrandBudapest1"))

p3 <- ggplot(data = GINIp, 
       aes(x = round, y = gini, fill = treatment, color = treatment, lty = treatment)) +
          layout +
          theme(legend.position="bottom") +
          # geom_vline(xintercept = 10, alpha = 0.66) +
          geom_line(show.legend=FALSE) +
          geom_point() +
          scale_x_continuous(name="",  breaks = 1:10) +
          scale_y_continuous(limits = c(0, upperLimit), expand = c(0, 0)) +
          labs(y = "Gini (Poor)") +
          scale_color_manual(values = wes_palette("GrandBudapest1"))

(p1 | (p2 / p3)) + plot_layout(guides = "collect") & theme(legend.position = "bottom")

rm(list = c("GINI", "GINIp", "GINIr", "p1", "p2", "p3"))
```


```{r tableGINI, results = "asis", warning = FALSE}

# create subsets
main_all  <- main[round == 10]
main_poor <- main[round == 10 & rich == FALSE]
main_rich <- main[round == 10 & rich == TRUE]

# create table
if(knitr::is_html_output()){
  type <- "html"
} else {
  type = "latex"
}

stargazer(lm(formula = gini ~ treatment, data = main_all),
          lm(formula = gini ~ treatment, data = main_poor),
          lm(formula = gini ~ treatment, data = main_rich),

          column.labels = c("All", "Below median", "Above median"),
          model.numbers = FALSE,
          dep.var.labels = "Gini",
          header=FALSE,
          covariate.labels = c("Replication"),

          type = type, digits = 2, omit.stat = c("adj.rsq", "f"), df = FALSE
          )
```


```{r summary2, results = "asis", warning = FALSE}

if(knitr::is_html_output()){
  type <- "html"
} else {
  type = "latex"
}

replication <- main[treatment == "replication" & round == 10, gini]
GMTV    <- main[treatment == "noPunish10" & round == 10, gini]


rows <- sapply(X = list(replication, GMTV), FUN = NROW) %>% max()
temp <- data.frame(replication = c(replication, rep(NA, rows - NROW(replication))),
                   GMTV = c(GMTV, rep(NA, rows - NROW(GMTV))))

stargazer(temp,
          summary.stat = c("mean", "median","sd", "max", "min", "n"),
          type = type, 
          flip = TRUE, 
          header=FALSE)

rs2 <- wilcox.test(replication, GMTV)$p.value %>% round(digits = 4) %>% formatC(format = "f", digits = 4)

```

The rank sum test yields a p-Value of `r rs2` for the mean ```gini``` during the last period of the game.


## Sample Properties

```{r matchOutcomes}
covariates <- data.table::merge.data.table(x  = covs,
                                           y  = main[round == 10, .(groupID, stock, gini)],
                                           by = c("groupID"),
                                           allow.cartesian = TRUE)
```



```{r tableCovariates, results = "asis", warning = FALSE}


# create table
if(knitr::is_html_output()){
  type <- "html"
} else {
  type = "latex"
}

olsStock1 <- lm(formula = stock ~ gender + age + pq01 + pq02 + pq03 + pq04 + pq05 + pq06 +
                  pq07 +pq08 + pq09 + pq10 + pq11 + pq12 + pq13 + pq14, 
                data = covariates[treatment == "replication"])
olsStock2  <- lm(formula = stock ~ gender + age,
                data = covariates[treatment == "replication"])
olsGINI1  <- lm(formula = gini ~ gender + age + pq01 + pq02 + pq03 + pq04 + pq05 + pq06 +
                  pq07 + pq08 + pq09 + pq10 + pq11 + pq12 + pq13 + pq14, 
                data = covariates[treatment == "replication"])
olsGINI2  <- lm(formula = gini ~ gender + age,
                data = covariates[treatment == "replication"])

stargazer(olsStock1, olsStock2,
          olsGINI1, olsGINI2,
          
          se = list(coef(summary(olsStock1, cluster = c("groupID")))[, 2],
                    coef(summary(olsStock2, cluster = c("groupID")))[, 2],
                    coef(summary(olsGINI1,  cluster = c("groupID")))[, 2],
                    coef(summary(olsGINI2,  cluster = c("groupID")))[, 2]),

          column.labels   = c("Wealth", "Gini"),
          dep.var.labels.include = FALSE,
          column.separate = c(2, 2),
          model.numbers = FALSE,
          header=FALSE,
          covariate.labels = c("female", "age", 
                               "I am a quick thinker",
                               "I get easily offended",
                               "very satisfied",
                               "very dependent",
                               "generally happy",
                               "work important",
                               "family important",
                               "friends important",
                               "religion important",
                               "politics important",
                               "most people trusted",
                               "hard work better",
                               "government responsible",
                               "incomes equal"),
          notes = "Robust standard errors in parentheses, clustered by group ID.",

          type = type, digits = 2, omit.stat = c("adj.rsq", "f"), df = FALSE
          )
```